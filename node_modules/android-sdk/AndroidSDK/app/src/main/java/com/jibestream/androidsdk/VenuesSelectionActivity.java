package com.jibestream.androidsdk;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.os.Parcelable;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.ListView;

import com.jibestream.jibestreamandroidlibrary.http.BasicAuthentication;
import com.jibestream.jibestreamandroidlibrary.mapBuilderV3.dataObjects.Location;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;

public class VenuesSelectionActivity extends Activity {
private static final String TAG = "VenuesSelectionActivity";
private ArrayList<Location> locations = new ArrayList<>();
public String url;
public BasicAuthentication basicAuthentication;

@Override
protected void onCreate(Bundle savedInstanceState) {
  super.onCreate(savedInstanceState);
  setContentView(R.layout.activity_venues_selection);

  Bundle bundle = getIntent().getExtras();
  if (bundle != null) {
    Parcelable[] ps = bundle.getParcelableArray("locations");
    for (int i = 0; i < ps.length; i++) {
      Location location = (Location) ps[i];
      if (location.name.equalsIgnoreCase("root")) continue;
      if (!location.status.equalsIgnoreCase("active")) continue;
      locations.add(location);
    }
    Collections.sort(locations, new Comparator<Location>() {
      @Override
      public int compare(Location lhs, Location rhs) {
        return lhs.name.compareTo(rhs.name);
      }
    });
    url = bundle.getString("url");
    basicAuthentication = (BasicAuthentication) bundle.get("basicAuthentication");
    //
    populateList();
  } else {
    // TODO: 2016-01-27 fix
    Log.e(TAG, "Shouldn't be here...");
    Intent intent = new Intent(this, SplashActivity.class);
    startActivity(intent);
  }
  startService(new Intent(this, MService.class));
}

private void populateList() {
  List<String> l = new ArrayList<>();
  for (Location location : locations) {
    if (location != null) l.add(location.name);
  }
  ListView venuesListView = (ListView) findViewById(R.id.venuesListView);
  ArrayAdapter<String> stringArrayAdapter = new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, l);
  venuesListView.setAdapter(stringArrayAdapter);
  venuesListView.setOnItemClickListener(onItemClickListener);
}

@Override
protected void onSaveInstanceState(Bundle outState) {
  outState.putParcelableArrayList("loc", locations);
  outState.putString("url", url);
  outState.putParcelable("basicAuthentication", basicAuthentication);
  super.onSaveInstanceState(outState);
}

@Override
protected void onRestoreInstanceState(Bundle savedInstanceState) {
  locations = savedInstanceState.getParcelableArrayList("loc");
  url = savedInstanceState.getString("url");
  basicAuthentication = (BasicAuthentication) savedInstanceState.get("basicAuthentication");
  populateList();
  super.onRestoreInstanceState(savedInstanceState);
}

private AdapterView.OnItemClickListener onItemClickListener = new AdapterView.OnItemClickListener() {
  public void onItemClick(AdapterView parent, View v, int position, long id) {
    Location location = locations.get(position);
    Intent intent = VenueDataActivity.getIntent(VenuesSelectionActivity.this, url, location.projectId, basicAuthentication);
    startActivity(intent);
  }
};
}
